{% load i18n lfs_modeltranslation_tags %}

<div id="variants">
    <h2>{% trans 'Property Groups' %}</h2>
    <form action="{% url 'lfs_update_product_property_groups' product.id %}"
          method="post">
        {% csrf_token %}
        <select name="selected-property-groups"
                multiple="multiple"
                class="selected-property-groups">
            {% for property_group in shop_property_groups %}
                <option value="{{ property_group.id }}"
                        {% if property_group.selected %}selected="selected"{% endif %}>
                    {{ property_group.name }}
                </option>
            {% endfor %}
        </select>
        <div class="buttons">
            <input type="submit"
                   class="button"
                   value="{% trans 'Update property groups' %}">
        </div>
    </form>

    <h2 class="heading-middle">{% trans 'Local properties' %}
        <a href="" class="discreet property-edit-mode">
            <img src="{{ STATIC_URL }}icons/pencil.png"
                 alt="{% trans 'Edit' %}"
                 title="{% trans 'Edit variant' %}" />
        </a>
    </h2>
    <form id="property-add-form"
          class="property-edit-field"
          action="{% url 'lfs_manage_add_property' product.id %}"
          method="post">
        <fieldset>
            <legend>{% trans "Add property" %}</legend>
            {{ property_form.non_field_errors }}
            {% translatedfields property_form "name" %}
                <div class="field">
                    <div class="label">
                        {{ translated_field.label_tag }}
                    </div>
                    {{ translated_field.errors }}
                    {{ translated_field }}
                </div>
            {% endtranslatedfields %}

            <input class="ajax-save-button"
                   type="submit"
                   value="{% trans 'Add property' %}" />
        </fieldset>
    </form>

    {% for property in local_properties %}
        <div style="font-weight:bold">{% fortranslatedattrs property "name" 0 %}{% if translated_attr %}[{{ translation_language }}]: {{ translated_attr }}{% if not fortranslatedattrsloop.last %}, {% endif %}{% endif %}{% endfortranslatedattrs %}
            {% if not forloop.first %}
                <a href="{% url 'lfs_manage_change_property_position' %}?product_id={{ product.id }}&amp;property_id={{ property.id }}&amp;direction=up"
                   class="ajax-link property-edit-field">
                    <image src="{{ STATIC_URL }}icons/arrow_up.png"
                           alt="{% trans 'Up' %}"
                           title="{% trans 'Up' %}"/>

                </a>
            {% endif %}
            {% if not forloop.last %}
                <a href="{% url 'lfs_manage_change_property_position' %}?product_id={{ product.id }}&amp;property_id={{ property.id }}&amp;direction=down"
                        class="ajax-link property-edit-field">
                    <image src="{{ STATIC_URL }}icons/arrow_down.png"
                           alt="{% trans 'Down' %}"
                           title="{% trans 'Down' %}"/>
                </a>
            {% endif %}

            <a href="{% url 'lfs_manage_delete_property' product.id property.id %}"
               class="delete-link property-edit-field"
               dialog_message="{% trans 'Do you really want to delete this property and all its options?' %}"
               dialog_yes_button_class="ajax-save-button">
                <image src="{{ STATIC_URL }}icons/cross.png"
                       alt="delete"
                       title="{% trans 'Delete property' %}"/>
            </a>
        </div>
        <div class="property-options">
            {% for option in property.options.all %}
                <div>
                    {% fortranslatedattrs option "name" 0 %}{% if translated_attr %}[{{ translation_language }}]: {{ translated_attr }}{% if not fortranslatedattrsloop.last %}, {% endif %}{% endif %}{% endfortranslatedattrs %}
                    <a href="{% url 'lfs_manage_delete_property_option' product.id option.id %}"
                       class="delete-link property-edit-field"
                       dialog_message="{% trans 'Do you really want to delete this option?' %}"
                       dialog_yes_button_class="ajax-save-button">
                        <image src="{{ STATIC_URL }}icons/cross.png"
                               alt="delete"
                               title="{% trans 'Delete option' %}"/>

                    </a>
                </div>
            {% endfor %}
            <div class="property-edit-field">
                <form action="{% url 'lfs_manage_add_property_option' product.id %}"
                      method="post">
                    <fieldset>
                        <legend>{% trans "Add option" %}</legend>
                        {% if current_property_option_form and current_property_option_form.property_id == property.id %}
                            {{ current_property_option_form.non_field_errors }}
                            {% translatedfields current_property_option_form "name" %}
                                <div class="field">
                                    <div class="label">
                                        {{ translated_field.label_tag }}
                                    </div>
                                    {{ translated_field.errors }}
                                    {{ translated_field }}
                                </div>
                            {% endtranslatedfields %}
                        {% else %}
                            {{ property_option_form.non_field_errors }}
                            {% translatedfields property_option_form "name" %}
                                <div class="field">
                                    <div class="label">
                                        {{ translated_field.label_tag }}
                                    </div>
                                    {{ translated_field.errors }}
                                    {{ translated_field }}
                                </div>
                            {% endtranslatedfields %}
                        {% endif %}

                        <input type="hidden" name="property_id" value="{{ property.id }}" />
                        <input type="submit"
                               class="ajax-save-button"
                               value="{% trans 'Add option' %}" />
                    </fieldset>
                </form>
            </div>
        </div>
    {% endfor %}

    <h2 class="heading-middle">{% trans 'Variants' %}</h2>
    <form action="{% url 'lfs_manage_add_variants' product.id %}"
          class="variants-add-form"
          method="post">
        {% if variant_simple_form.non_field_errors %}
            {{ variant_simple_form.non_field_errors }}
        {% endif %}
        <table>
            <tr>
                <th>
                    {% trans 'Slug' %}
                </th>
                <th>
                    {% trans 'Name' %}
                </th>
                <th>
                    {% trans 'Price' %}
                </th>
                {% for property in all_properties %}
                    <th>
                        {{ property.name }}
                    </th>
                {% endfor %}
                <th></th>
            </tr>
            <tr>
                <td>
                    {% translatedfields variant_simple_form "slug" %}
                        <div class="translated-field">
                            <div class="label">
                                {{ translation_language }}:
                            </div>
                            {{ translated_field.errors }}
                            {{ translated_field }}
                        </div>
                    {% endtranslatedfields %}
                </td>
                <td>
                    {% translatedfields variant_simple_form "name" %}
                        <div class="translated-field">
                            <div class="label">
                                {{ translation_language }}:
                            </div>
                            {{ translated_field.errors }}
                            {{ translated_field }}
                        </div>
                    {% endtranslatedfields %}
                </td>
                <td>
                    {{ variant_simple_form.price }}
                </td>
                {% for property in all_properties %}
                    <td>
                        <select name="property_{{ property.id }}">
                            <option value="all">{% trans 'All' %}</option>
                            {% for option in property.options.all %}
                                <option value="{{ option.id }}">
                                    {{ option.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                {% endfor %}
                <td>
                    <input type="submit"
                           value="{% trans 'Add variant(s)' %}"
                           class="ajax-save-button" />
                </td>
            </tr>
        </table>
    </form>

    {% if variants %}
        <form id="variants-form"
              action="{% url 'lfs_manage_update_variants' product.id %}"
              method="post">
            <table>
                <th>
                    <input type="checkbox" class="select-all" value="delete" />
                </th>
                <th>
                    {% trans 'Pos.' %}
                </th>
                <th>
                    <input type="checkbox" class="select-all" value="active" />
                    {% trans 'Active' %}
                </th>
                <th>
                    {% trans 'URL' %}
                </th>
                <th>
                    <input type="checkbox" class="select-all" value="active_sku" />
                    {% trans 'SKU' %}
                </th>
                <th>
                    <input type="checkbox" class="select-all" value="active_name" />
                </th>
                <th>
                    {% trans 'Name' %}
                </th>
                {% for property in all_properties %}
                    <th>
                        {{ property.name }}
                    </th>
                {% endfor %}
                <th colspan="2">
                    <input type="checkbox"
                           class="select-all"
                           value="price" />
                    {% trans 'Price' %}
                </th>
                <th>
                    {% trans 'Default' %}
                </th>
                {% for variant in variants %}
                    <tr>
                        <td>
                            <input type="hidden" name="variant-{{ variant.id }}" />
                            <input type="checkbox" class="select-delete" name="delete-{{ variant.id }}" />
                        </td>
                        <td>
                            <input type="text" name="position-{{ variant.id }}" value="{{ variant.position }}" size="3" />
                        </td>
                        <td>
                            <input type="checkbox" class="select-active" name="active-{{ variant.id }}" {% if variant.active %}checked="checked"{% endif %} />
                        </td>
                        <td>
                            {% fortranslatedattrs variant "slug" 1 %}
                                <div class="translated-field">
                                    <div class="label">
                                        {{ translation_language }}:
                                    </div>
                                    <input type="text" name="slug-{{ translation_language }}-{{ variant.id }}" value="{{ translated_attr }}" />
                                </div>
                            {% endfortranslatedattrs %}
                        </td>
                        <td>
                            <input type="checkbox" class="select-active_sku" name="active_sku-{{ variant.id }}" {% if variant.active_sku %}checked="checked"{% endif %} />
                            <input type="text" name="sku-{{ variant.id }}" value="{{ variant.sku }}" />
                        </td>
                        <td>
                            <input type="checkbox" class="select-active_name" name="active_name-{{ variant.id }}" {% if variant.active_name %}checked="checked"{% endif %} />
                        </td>
                        <td>
                            {% fortranslatedattrs variant "name" 1 %}
                                <div class="translated-field">
                                    <div class="label">{{ translation_language }}:</div> <input type="text" name="name-{{ translation_language }}-{{ variant.id }}" value="{{ translated_attr }}" />
                                </div>
                            {% endfortranslatedattrs %}
                        </td>

                        {% for property in variant.properties %}
                            <td>
                                <select name="property-{{ variant.id }}|{{ property.id }}">
                                    <option value=""></option>
                                    {% for option in property.options %}
                                        <option value="{{ option.id }}"
                                                {% if option.selected %}selected="selected"{% endif %}>
                                            {{ option.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                        {% endfor %}
                        <td>
                            <input type="checkbox" class="select-price" name="active_price-{{ variant.id }}" {% if variant.active_price %}checked="checked"{% endif %} />
                        </td>
                        <td class="number">
                            <input class="number" type="text" name="price-{{ variant.id }}" value="{{ variant.price }}" />
                        </td>
                        <td>
                            <input type="radio" name="default_variant" value="{{ variant.id }}" {% if product.default_variant.id == variant.id %}checked="checked"{% endif %} />
                        </td>
                        <td>
                            <a href="{% url 'lfs_manage_product' variant.id %}">
                                <img src="{{ STATIC_URL }}icons/pencil.png"
                                     alt="Edit"
                                     title="{% trans 'Edit variant' %}" />
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            </table>
            <div class="buttons">
                <input type="submit" name="delete" class="button ajax-save-button" value="{% trans 'Delete' %}" />
                <input type="submit" name="update" class="button ajax-save-button" value="{% trans 'Save' %}" />
            </div>
        </form>

        <h2 class="heading-middle">{% trans 'Category variant' %}</h2>
        <form action="{% url 'lfs_update_category_variant' product.id %}"
              method="post">
            <div class="label">
                {{ category_variant_form.category_variant.label_tag }}:
            </div>
            <div>
                {{ category_variant_form.category_variant }}
            </div>
            <div class="buttons">
                <input type="submit"
                       value="{% trans 'Change category variant' %}"
                       class="button ajax-save-button" />
            </div>
        </form>

        <h2 class="heading-middle">{% trans 'Display type' %}</h2>
        <form action="{% url 'lfs_manage_edit_sub_type' product.id %}"
              method="post">
            <div class="label">
                {{ display_type_form.variants_display_type.label_tag }}:
            </div>
            <div>
                {{ display_type_form.variants_display_type }}
            </div>
            <div class="buttons">
                <input type="submit"
                       value="{% trans 'Change variant display type' %}"
                       class="button ajax-save-button" />
            </div>
        </form>
    {% endif %}
</div>
<script>
    var em = $.cookie("property-edit-mode");
    if (em == "true") {
        $(".property-edit-field").show();
    }
    else {
        $(".property-edit-field").hide();
    }
</script>
